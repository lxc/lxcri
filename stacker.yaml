build:
    from:
        type: docker
        url: docker://ubuntu:bionic

    import:
        - https://dl.google.com/go/go1.12.5.linux-amd64.tar.gz
        - https://github.com/lxc/lxc/archive/lxc-3.0.4.tar.gz

    run: |
        sed -i 's/# deb-src/deb-src/g' /etc/apt/sources.list

        apt-get update
        apt-get -y install \
            make git gcc pkg-config

        apt-get -y build-dep lxc
        apt -y install libssl-dev

        cd /usr/local
        tar xvf /stacker/go1.12.5.linux-amd64.tar.gz
        cd -

        tar xvf /stacker/lxc-3.0.4.tar.gz
        cd lxc-lxc-3.0.4
        ./autogen.sh

        ./configure \
            --enable-static \
            --enable-shared \
            --disable-tools \
            --disable-commands \
            --disable-doc \
            --disable-rpath \
            --with-distro=ubuntu \
            --enable-pam \
            --enable-caps \
            --enable-seccomp \
            --enable-cgroups \
            --enable-selinux \
            --enable-apparmor \
            --enable-openssl \
            --prefix=/usr

        make -j$(cat /proc/cpuinfo | grep ^processor | wc -l)
        make install

        sed -i 's/@DLOG_LIBS@/-ldl/g' /usr/lib/pkgconfig/lxc.pc

    build_only: true

do_build:
    from:
        type: built
        tag: build

    binds:
        - ${{PWD}} -> /go/src/crio-lxc

    run: |
        export GO111MODULE=on
        export HOME=/var/tmp
        export PATH=$PATH:/usr/local/go/bin

        cd /go/src/crio-lxc
        make crio-lxc

    build_only: true
